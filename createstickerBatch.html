<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    
    <style>
	.canvas-wrapper {
	    position: relative;
	}

	.canvas-wrapper:before{
	            content:"";
	            display: block;
	            padding-top: 50%;
	}

	.canvas-wrapper canvas {
	    position: absolute;
	    top: 0;
	    left: 0;
	}
     </style>
</head>
    
<script src="https://miro.com/app/static/sdk.1.1.js"></script>
<script src="./js/const.js"></script>
<body onload="loadImage()">
<form>

	<input type="file" name="selfile" accept='.csv' required><br><br>
	
    <textarea name="csv" rows="10" cols="40" readonly style='display:none'></textarea>
    
	<button type="button" onclick='readCSV()'>アップロード</button>
	<button type="button" id="close" onclick='closeWindow()'>閉じる</button>   

 	<canvas id = "canvas" width="446" height="200" style='display:none'></canvas><br>

	<input type='hidden' name='dataurl'><br>

</form>


<script>

	async function loadImage() {
		const res = await imageOnLoad('').catch(e => {
			console.log('onload error', e);
		});
		//画像ロードが完了してからキャンバスの準備をする
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		//キャンバスのサイズを画像サイズに合わせる
		canvas.width = res.width;
		canvas.height = res.height;
		//キャンバスに画像を描画（開始位置0,0）
		ctx.drawImage(res, 0, 0);
		// DataUrlをクリア
		document.getElementsByName('dataurl')[0].value = "";
	}

	
	function imageOnLoad() {
	  return new Promise((resolve, reject) => {
	    const img = new Image();
	    img.onload = () => resolve(img);
	    img.onerror = (e) => reject(e);
	    img.src = './img/sticker.png';
	  });
	}

    //ダイアログでファイルが選択された時
    var obj1 = document.getElementsByName("selfile");
    obj1[0].addEventListener("change",function(evt){

        var file = evt.target.files;

        //FileReaderの作成
        var reader = new FileReader();
        //テキスト形式で読み込む
        reader.readAsText(file[0]);
        
        //読込終了後の処理
        reader.onload = function(ev){
        //テキストエリアに表示する
        document.forms[0].csv.value = reader.result;
        }
    },false);

	async function readCSV(){
	
		document.body.style.cursor = 'wait';

		var obj1 = document.getElementsByName("csv");
		let lines = obj1[0].value.split(/\r?\n/);
		let datas = lines.map(line=> line.split(','));

		// ヘッダ情報の取得
		let idIndex = await datas[0].indexOf('スタッフ番号');
		let nameIndex = await datas[0].indexOf('スタッフ氏名');
		let timeIndex = await datas[0].indexOf('勤務時間');
				        
		for(let i=1; i< datas.length; i++){
			var d = datas[i];
								
			await drawText("emploee_id", d[idIndex], 35, 30, '');			// スタッフ番号
			await drawText("emploee_name", d[nameIndex], 90, Math.min(555/getBytes(d[nameIndex]), maxFont), 'bold ');			// スタッフ氏名
			await drawText("working_hour", d[timeIndex], 130, 25, '');
			
			await createWidgets(d[idIndex], d[nameIndex], d[timeIndex]);
		}
		
		document.body.style.cursor = 'auto';
		
        // ModalWindowを閉じる
        miro.board.ui.closeModal();
	
	}
    

	function getBytes(value){
	    var length = 0;
	    for (var i = 0; i < value.length; i++) {
		    var c = value.charCodeAt(i);
		    if ((c >= 0x0 && c < 0x81) || (c === 0xf8f0) || (c >= 0xff61 && c < 0xffa0) || (c >= 0xf8f1 && c < 0xf8f4)) {
		        length += 1;
		    } else {
		        length += 2;
		    }
	    }
	    return length;
	}

    // Canvas内に文字を表示する
    function drawText(name, text, ypos, fontsize, font){

        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        context.font = font + fontsize + 'px serif';
        context.fillStyle = '#404040';
        // 右寄せで表示
        context.textBaseline = 'center';
        context.textAlign = 'right';
        //座標を指定して文字を描く
        var x = (canvas.width -15);
        var y = (canvas.offsetTop + ypos);
        
        context.fillText(text, x, y);
    }
    
    // Canvasオブジェクトからイメージを取得する
    function getImagefromCanvas(id){
        return new Promise((resolve, reject) => {
            const image = new Image();
            const ctx = document.getElementById(id).getContext("2d");
            image.onload = () => resolve(image);
            image.onerror = (e) => reject(e);
            image.src = ctx.canvas.toDataURL();
        });                            
    }
    
    // 編集用のCanvasから文字をクリアする
    function clearText(context, x,y, height){
        context.clearRect(x, y, 300, height);
    }
    


    // 画面を閉じる
    function closeWindow(){
        miro.board.ui.closeModal();
    }

    // Widgetを作成して画面を閉じる
    async function createWidgets(emploeeId, emploeeName, workingHour){
    
    	document.getElementsByName('dataurl')[0].value = await document.getElementById('canvas').toDataURL();

        setTimeout(function(){
            if(document.getElementsByName('dataurl')[0].value === ""){
                return false;
            }
        })

        // 合成された画像の一時ファイルを作成
        var dataurl = document.getElementsByName('dataurl')[0].value;
        await fetch(api_uri , {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'emploee_id' : emploeeId , 'dataurl' : dataurl })
        }).then(function (response) {
            console.log(response.text());
        }).then(function (text) {
            console.log("RESULT: " + text);
        });

        // Widgetの作成
        await miro.board.widgets.create({ type: 'image', scale: 1.0, url: api_uri + emploeeId + '.png', metadata:{[client_id] :{staffid: emploeeId, staffName: emploeeName, working_hour: workingHour}}});

        
        // 一時ファイルの削除
        await fetch(api_uri + emploeeId  + '.png' , {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: '{}'
        }).then(function (response) {
            console.log(response.text());
        }).then(function (text) {
            console.log("RESULT: " + text);
        });
        
        
        // 送信用画像情報をクリア
        var canvas = await document.getElementById('canvas');
        var context = await canvas.getContext('2d');
		await context.clearRect(0, 0, 446, 200);
        loadImage();
        
		await loadImage();
                
    }
    </script>        
  </body>    
    
</html>
